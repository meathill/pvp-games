# æ¶æ„æ¦‚è§ˆ

æœ¬æ–‡æ¡£æè¿° PVP Games é¡¹ç›®çš„æ•´ä½“æ¶æ„ã€è®¾è®¡å†³ç­–å’ŒæŠ€æœ¯å®ç°ã€‚

## é¡¹ç›®ç»“æ„

```
pvp-games/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/      # å…±äº«å·¥å…·ã€ç±»å‹å’Œç½‘ç»œæŠ½è±¡
â”‚   â”œâ”€â”€ games/       # æ¸¸æˆé€»è¾‘å’Œ React ç»„ä»¶
â”‚   â”œâ”€â”€ signaling/   # Cloudflare Worker ä¿¡ä»¤æœåŠ¡
â”‚   â””â”€â”€ web/         # Next.js å‰ç«¯åº”ç”¨
â”œâ”€â”€ docs/            # é¡¹ç›®æ–‡æ¡£
â””â”€â”€ package.json     # Monorepo æ ¹é…ç½®
```

## æ–‡æ¡£åŸåˆ™

- **ç²¾ç®€å¿…è¦**ï¼šåªä¿ç•™ READMEã€æµ‹è¯•æ–‡æ¡£ã€æ¶æ„æ–‡æ¡£å’Œ Copilot æŒ‡å—
- **åŠæ—¶æ›´æ–°**ï¼šæ–‡æ¡£ä¸ä»£ç åŒæ­¥æ›´æ–°ï¼Œé¿å…è¿‡æ—¶ä¿¡æ¯
- **ä¸´æ—¶ä¿¡æ¯åˆ†ç¦»**ï¼šdev-note.md/WIP.md ç”¨äºçŸ­æœŸè®¡åˆ’ï¼ŒTODO.md ç”¨äºé•¿æœŸè§„åˆ’

## ç½‘ç»œæ¶æ„

### å½“å‰å®ç°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        WebSocket        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Host      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Signaling  â”‚
â”‚  (Browser)  â”‚                         â”‚  (Durable   â”‚
â”‚             â”‚                         â”‚   Object)   â”‚
â”‚  æ¸¸æˆé€»è¾‘    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
â”‚  çŠ¶æ€å¹¿æ’­    â”‚        WebSocket        â”‚  æ¶ˆæ¯ä¸­ç»§   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â”‚ WebSocket
                                               â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚   Guest     â”‚
                                        â”‚  (Browser)  â”‚
                                        â”‚             â”‚
                                        â”‚  è¾“å…¥å‘é€   â”‚
                                        â”‚  çŠ¶æ€æ¥æ”¶   â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å½“å‰å®ç°ï¼šæ··åˆä¼ è¾“

ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨ **WebRTC P2P**ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ° **WebSocket ä¸­ç»§**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     WebRTC DataChannel    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Host      â”‚â—„â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–ºâ”‚   Guest     â”‚
â”‚  (Browser)  â”‚      P2P ä½å»¶è¿Ÿ          â”‚  (Browser)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                        â”‚
       â”‚ ä¿¡ä»¤äº¤æ¢ + å›é€€                         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ WebSocket
                  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                  â”‚  Signaling  â”‚
                  â”‚  (DO + Hib) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**WebRTC P2P æ¨¡å¼ï¼ˆé¦–é€‰ï¼‰ï¼š**
- ç›´æ¥ç‚¹å¯¹ç‚¹è¿æ¥ï¼Œå»¶è¿Ÿ 10-50ms
- ä½¿ç”¨ Google STUN æœåŠ¡å™¨è¿›è¡Œ NAT ç©¿é€
- çº¦ 85-90% çš„æƒ…å†µå¯ä»¥å»ºç«‹ P2P

**WebSocket ä¸­ç»§æ¨¡å¼ï¼ˆå›é€€ï¼‰ï¼š**
- å½“ WebRTC å¤±è´¥æ—¶è‡ªåŠ¨å¯ç”¨
- é€šè¿‡ Cloudflare Durable Object ä¸­è½¬
- å»¶è¿Ÿ 50-150msï¼Œä½†æ›´å¯é 

### ä¼˜åŒ–ç‰¹æ€§

1. **Location Hints**ï¼šDurable Object å®ä¾‹æ”¾ç½®åœ¨æˆ¿ä¸»æœ€è¿‘çš„æ•°æ®ä¸­å¿ƒ
2. **Hibernation API**ï¼šWebSocket ç©ºé—²æ—¶ä¼‘çœ ï¼Œé™ä½æˆæœ¬
3. **çº¦ 8 FPS å¸§ç‡**ï¼šä¼˜åŒ–çš„ 120ms tick é—´éš”
4. **è‡ªåŠ¨å›é€€**ï¼šWebRTC 5 ç§’è¶…æ—¶åè‡ªåŠ¨åˆ‡æ¢åˆ° WebSocket

## æ¨¡å—èŒè´£

### packages/shared

**æ ¸å¿ƒå…±äº«æ¨¡å—**ï¼Œæä¾›ï¼š
- **ç±»å‹å®šä¹‰**ï¼š`PeerRole`ã€`RealtimeEndpoint`ã€`RealtimeEnvelope`
- **ç½‘ç»œæŠ½è±¡**ï¼š`InMemoryRealtimeEndpoint`ï¼ˆæµ‹è¯•ç”¨ï¼‰ã€`WebRTCRealtimeEndpoint`ã€`WebSocketRelayEndpoint`
- **è¿æ¥ç®¡ç†**ï¼š`ConnectionManager`ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä½³ä¼ è¾“æ–¹å¼ï¼‰
- **å·¥å…·å‡½æ•°**ï¼š`createSharedContext`ã€éšæœºç§å­ç®¡ç†

### packages/games

**æ¸¸æˆå®ç°æ¨¡å—**ï¼ŒåŒ…å«ï¼š
- **æ¸¸æˆå¼•æ“**ï¼š`DuelSnakeGame`ï¼ˆç¡®å®šæ€§æ¸¸æˆé€»è¾‘ï¼‰
- **åœ¨çº¿åŒæ­¥**ï¼š`DuelSnakeOnlineHost`ã€`DuelSnakeOnlineClient`
- **React ç»„ä»¶**ï¼š`DuelSnakeExperience`ï¼ˆæœ¬åœ°ï¼‰ã€`DuelSnakeOnline`ï¼ˆåœ¨çº¿ï¼‰

### packages/signaling

**ä¿¡ä»¤æœåŠ¡æ¨¡å—**ï¼ŒåŸºäº Cloudflare Workersï¼š
- **Worker å…¥å£**ï¼šHTTP/WebSocket è·¯ç”±
- **Durable Object**ï¼š`GameRoom` ç±»ï¼Œç®¡ç†æˆ¿é—´çŠ¶æ€å’Œæ¶ˆæ¯è½¬å‘
- æ”¯æŒæœ¬åœ°å¼€å‘ï¼ˆ`wrangler dev`ï¼‰å’Œç”Ÿäº§éƒ¨ç½²

### packages/web

**å‰ç«¯åº”ç”¨**ï¼ŒåŸºäº Next.jsï¼š
- **é¡µé¢è·¯ç”±**ï¼šæ¸¸æˆå¤§å…ã€æ¸¸æˆè¯¦æƒ…é¡µ
- **æ¸¸æˆåŠ è½½**ï¼šåŠ¨æ€å¯¼å…¥æ¸¸æˆç»„ä»¶
- **éƒ¨ç½²**ï¼šé€šè¿‡ OpenNext éƒ¨ç½²åˆ° Cloudflare Pages

## æ¶ˆæ¯åè®®

### ä¿¡å°æ ¼å¼

```typescript
interface RealtimeEnvelope<T> {
  from: 'host' | 'guest';
  payload: T;
  createdAt: number;
}
```

### æ¸¸æˆæ¶ˆæ¯ç±»å‹

```typescript
type DuelSnakeWireMessage =
  | { type: 'ready' }
  | { type: 'input'; direction: Direction; clientTick?: number }
  | { type: 'state'; state: DuelSnakeState; serverTime: number }
  | { type: 'sync-request' }
  | { type: 'ping'; timestamp: number }
  | { type: 'pong'; timestamp: number };
```

### ä¿¡ä»¤æ¶ˆæ¯ç±»å‹

```typescript
type RelayWireMessage =
  | { type: 'join'; role: PeerRole }
  | { type: 'joined'; role: PeerRole }
  | { type: 'leave'; role: PeerRole }
  | { type: 'room-ready' }
  | { type: 'game'; payload: unknown }
  | { type: 'ping' }
  | { type: 'pong' };
```

## æ¸¸æˆåŒæ­¥æ¨¡å‹

é‡‡ç”¨ **Host æƒå¨æ¨¡å¼**ï¼š

1. **Host ç«¯**ï¼š
   - è¿è¡Œæ¸¸æˆå¼•æ“ï¼Œå¤„ç†æ‰€æœ‰é€»è¾‘
   - æ¥æ”¶ Guest è¾“å…¥ï¼Œæ”¾å…¥ç¼“å†²åŒº
   - æ¯ä¸ª tick å¹¿æ’­å®Œæ•´çŠ¶æ€

2. **Guest ç«¯**ï¼š
   - å‘é€è¾“å…¥åˆ° Host
   - æ¥æ”¶å¹¶æ¸²æŸ“ Host å¹¿æ’­çš„çŠ¶æ€
   - æµ‹é‡å»¶è¿Ÿç”¨äº UI æ˜¾ç¤º

### ç¡®å®šæ€§ä¿è¯

- ä½¿ç”¨å›ºå®šéšæœºç§å­ç”Ÿæˆé£Ÿç‰©ä½ç½®
- æ¸¸æˆé€»è¾‘å®Œå…¨ç¡®å®šï¼Œç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒç»“æœ
- æ”¯æŒå›æ”¾å’Œæ ¡éªŒ

## å¼€å‘æµç¨‹

### è®¾è®¡ â†’ æµ‹è¯• â†’ ç¼–ç 

1. **è®¾è®¡é˜¶æ®µ**ï¼š
   - å®šä¹‰åè®®å’ŒçŠ¶æ€æœº
   - ç»˜åˆ¶æ—¶åºå›¾
   - ç¡®å®š API æ¥å£

2. **æµ‹è¯•é˜¶æ®µ**ï¼š
   - ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯é€»è¾‘
   - ç¼–å†™åè®®æµ‹è¯•éªŒè¯æ¶ˆæ¯æ ¼å¼
   - ç¼–å†™é›†æˆæµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯æµç¨‹

3. **ç¼–ç é˜¶æ®µ**ï¼š
   - å®ç°åŠŸèƒ½ï¼Œç¡®ä¿æµ‹è¯•é€šè¿‡
   - å°æ­¥æäº¤ï¼Œé¢‘ç¹éªŒè¯
   - æ›´æ–°æ–‡æ¡£

## è·¯çº¿å›¾

### âœ… å·²å®Œæˆ

- [x] æœ¬åœ°åŒäººè´ªåƒè›‡
- [x] WebSocket æ¶ˆæ¯ä¸­ç»§
- [x] Cloudflare Durable Object æˆ¿é—´ç®¡ç†
- [x] åœ¨çº¿å¯¹æˆ˜å‰ç«¯é›†æˆ
- [x] å±€åŸŸç½‘æµ‹è¯•
- [x] éƒ¨ç½²æ–‡æ¡£
- [x] WebRTC P2P è¿æ¥

### ğŸš§ è¿›è¡Œä¸­

- [ ] å¹¿åŸŸç½‘éƒ¨ç½²å’Œæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–

### ğŸ“‹ è®¡åˆ’ä¸­

- [ ] æˆ¿é—´å¯†ç åŠŸèƒ½
- [ ] éšæœºåŒ¹é…ç³»ç»Ÿ
- [ ] è§‚æˆ˜åŠŸèƒ½
- [ ] æ›´å¤šæ¸¸æˆç±»å‹

## ç¯å¢ƒå˜é‡

### å‰ç«¯ (packages/web)

| å˜é‡ | è¯´æ˜ |
|------|------|
| `NEXT_PUBLIC_SIGNALING_URL` | ä¿¡ä»¤æœåŠ¡ WebSocket URL |

### ä¿¡ä»¤æœåŠ¡ (packages/signaling)

ç›®å‰ä¸éœ€è¦é¢å¤–ç¯å¢ƒå˜é‡ã€‚

### å¯é€‰é…ç½®

| å˜é‡ | è¯´æ˜ |
|------|------|
| `TURN_URLS` | TURN æœåŠ¡å™¨ URLï¼ˆWebRTC ä¸­ç»§ï¼‰ |
| `TURN_USERNAME` | TURN è®¤è¯ç”¨æˆ·å |
| `TURN_CREDENTIAL` | TURN è®¤è¯å¯†ç  |

## ç›¸å…³æ–‡æ¡£

- [æœ¬åœ°æµ‹è¯•æŒ‡å—](./local-testing.md)
- [éƒ¨ç½²æŒ‡å—](./deployment.md)
- [æµ‹è¯•æŒ‡å—](./testing.md)
- [æ¸¸æˆåœ¨çº¿å¯¹æˆ˜è®¾è®¡](../packages/games/docs/duel-snake-online.md)
