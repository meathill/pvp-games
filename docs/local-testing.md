# 局域网联机测试指南

本文档介绍如何在本地局域网环境下测试 PVP 贪吃蛇的在线对战功能。

## 前置条件

- Node.js 18+
- pnpm

## 快速开始

### 1. 安装依赖

```bash
pnpm install
```

### 2. 启动信令服务器

在一个终端窗口运行：

```bash
pnpm dev:signaling
```

这会使用 Wrangler 在本地启动一个模拟 Cloudflare Workers 环境的服务器。

你会看到类似输出：

```
⎔ Starting local server...
[wrangler:inf] Ready on http://localhost:8787
```

### 3. 启动前端开发服务器

在另一个终端窗口运行：

```bash
pnpm dev
```

前端会在 `http://localhost:3000` 启动。

### 4. 测试联机对战

#### 同一台电脑测试（开两个浏览器窗口）

1. 打开 `http://localhost:3000/games/duel-snake-online`
2. 在第一个窗口点击"创建房间"，记下 6 位房间码
3. 在第二个窗口输入房间码，点击"加入房间"
4. 两人都加入后游戏自动开始

#### 局域网内两台电脑测试

1. 确保两台电脑在同一局域网
2. 获取运行服务器的电脑 IP 地址：
   - macOS/Linux: `ifconfig` 或 `ip addr`
   - Windows: `ipconfig`
3. 主机玩家：
   - 打开 `http://localhost:3000/games/duel-snake-online`
   - 点击"创建房间"
   - 记下房间码分享给对手
4. 访客玩家：
   - 打开 `http://<主机IP>:3000/games/duel-snake-online`
   - 展开"高级设置"
   - 将信令服务器地址改为 `ws://<主机IP>:8787/ws`
   - 输入房间码，点击"加入房间"
5. 游戏开始！

## 控制方式

- 方向键 (↑↓←→) 或 WASD 控制蛇的移动
- 先吃到 10 个果子的玩家获胜

## 架构说明

```
┌─────────────────┐         ┌─────────────────┐
│   主机 (Host)    │         │   访客 (Guest)   │
│  - 游戏逻辑      │         │  - 发送输入      │
│  - 状态广播      │         │  - 接收状态      │
└────────┬────────┘         └────────┬────────┘
         │                           │
         │     WebSocket 连接         │
         │                           │
         └───────────┬───────────────┘
                     │
              ┌──────┴──────┐
              │ 信令服务器   │
              │ (port 8787) │
              └─────────────┘
```

当前实现使用 WebSocket 进行消息中继。生产环境将支持：
- WebRTC 点对点连接（首选，延迟更低）
- WebSocket 回退（当 WebRTC 不可用时）

## 故障排除

### 连接失败

1. 检查信令服务器是否运行
2. 检查防火墙是否允许端口 8787
3. 确保两台电脑能互相 ping 通

### 游戏延迟高

- 局域网内延迟应该 < 10ms
- 检查网络质量
- 查看浏览器控制台是否有错误

### 房间码无效

- 房间码区分大小写
- 房间 1 分钟无人后自动清理
- 重新创建房间

## 下一步

完成局域网测试后，可以部署到 Cloudflare：

1. 将 Durable Object 部署到 Cloudflare Workers
2. 更新前端的服务器地址
3. 进行广域网测试

详见 [部署指南](./deployment.md)。
